<!DOCTYPE html>
<html>
<head>
    <title>Bakehub | Profile</title>
    <link rel="icon" type="image/png" href="bakehub_favicon.png">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

</head>

<body>
<!-- Header (same as index.html) -->
<header class="navbar">
    <image src="search.png" height="75"></image>
    <nav>
        <a href="index.html">Home</a>
        <a href="catalog.html">Catalog</a>
        <a href="help.html">Help</a>
        <a href="login.html" id="logout-link">Logout</a>
        <a href="add_product.html" id="add-product-link" style="display:none;">Add Product</a>
        <a href="profile.html" id="profile-link">Profile</a>

        <input type="checkbox" id="cart-toggle" class="cart-toggle">
        <label for="cart-toggle" class="cart-icon-container">
            <div class="cart-icon"><img src="cart-icon.png" alt="Cart Icon"></div>
            <div class="cart-count">0</div>
        </label>

        <label for="cart-toggle" class="overlay"></label>

        <div class="cart-panel">
            <div class="cart-header">
                <h2>My Cart</h2>
                <label for="cart-toggle" class="close-btn">&times;</label>
            </div>
            <div class="cart-items">
                <div class="empty-cart">
                    <div class="empty-cart-icon"><img src="cart-icon.png" alt="Cart Icon"></div>
                    <p>Your cart is empty</p>
                </div>
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>Total:</span>
                    <span>0.00</span>
                </div>
                <button class="checkout-btn">Proceed to Checkout</button>
            </div>
        </div>
    </nav>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="profile-wrapper">

        <!-- Not logged in fallback -->
        <div id="not-logged-in" style="display:none;">
            <h2>You're not logged in</h2>
            <p>Please <a href="login.html">log in</a> to view your profile.</p>
        </div>

        <!-- Profile content (shown when logged in) -->
        <div id="profile-content">

            <!-- Hero -->
            <div class="profile-hero">
                <div class="profile-avatar" id="profile-avatar">?</div>
                <div class="profile-hero-info">
                    <h1 id="profile-username">Loading...</h1>
                    <span class="role-badge" id="profile-role-badge">‚Äî</span>
                </div>
            </div>

            <!-- Tabs -->
            <div class="profile-tabs" id="profile-tabs">
                <button class="tab-btn active" data-tab="overview">Overview</button>
                <button class="tab-btn" data-tab="orders">Order History</button>
                <button class="tab-btn seller-only" data-tab="listings" style="display:none;">My Listings</button>
                <button class="tab-btn" data-tab="settings">Settings</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-panel active" id="tab-overview">
                <div class="profile-card">
                    <h3>Account Info</h3>
                    <div class="info-row">
                        <span class="info-label">Username</span>
                        <span class="info-value" id="ov-username">‚Äî</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Role</span>
                        <span class="info-value" id="ov-role">‚Äî</span>
                    </div>
                    <div class="info-row seller-only" id="ov-shoprow" style="display:none;">
                        <span class="info-label">Shop Name</span>
                        <span class="info-value" id="ov-shopname">‚Äî</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total Orders</span>
                        <span class="info-value" id="ov-orders">0</span>
                    </div>
                    <div class="info-row seller-only" id="ov-listingsrow" style="display:none;">
                        <span class="info-label">Active Listings</span>
                        <span class="info-value" id="ov-listings">0</span>
                    </div>
                </div>
            </div>

            <!-- Order History Tab -->
            <div class="tab-panel" id="tab-orders">
                <div class="profile-card">
                    <h3>Order History</h3>
                    <div id="orders-list">
                        <div class="empty-state">
                            <div class="empty-icon">üõçÔ∏è</div>
                            <p>No orders yet. Start shopping!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Listings Tab (sellers only) -->
            <div class="tab-panel" id="tab-listings">
                <div class="profile-card">
                    <h3>My Listings</h3>
                    <div id="listings-list">
                        <div class="empty-state">
                            <div class="empty-icon">üè™</div>
                            <p>You haven't listed any products yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-panel" id="tab-settings">
                <div class="profile-card">
                    <h3>Change Password</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" id="current-password" placeholder="Enter current password">
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="new-password" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" id="confirm-password" placeholder="Confirm new password">
                        </div>
                        <button class="save-btn" id="save-password-btn">Save Changes</button>
                    </div>
                </div>

                <div class="profile-card">
                    <h3>Danger Zone</h3>
                    <p style="color:#9b7a5a; font-size:0.9rem; margin:0 0 16px;">
                        Logging out will end your current session.
                    </p>
                    <button class="save-btn" id="profile-logout-btn"
                        style="background:#c0392b;">Logout</button>
                </div>
            </div>

        </div><!-- /#profile-content -->
    </div>
</main>

<!-- Footer -->
<footer class="footer">
    <p>CCAPDEV S12 Team Gardenia</p>
</footer>

<script src="script.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    /*  Session check  */
    const session = getSession();

    if (!session) {
        document.getElementById('profile-content').style.display = 'none';
        document.getElementById('not-logged-in').style.display  = 'block';
        return;
    }

    const users = getUsers();
    const user  = users[session.username];
    const isSeller = session.role === 'seller';

    /*  Populate hero  */
    document.getElementById('profile-avatar').textContent =
        session.username.charAt(0).toUpperCase();
    document.getElementById('profile-username').textContent =
        isSeller ? (user?.shopname || session.username) : session.username;
    document.getElementById('profile-role-badge').textContent =
        isSeller ? 'Seller' : 'Customer';

    /*  Overview  */
    document.getElementById('ov-username').textContent = session.username;
    document.getElementById('ov-role').textContent =
        isSeller ? 'Seller' : 'Customer';

    const orders = JSON.parse(
        localStorage.getItem('bakehubOrders_' + session.username) || '[]'
    );
    document.getElementById('ov-orders').textContent = orders.length;

    if (isSeller) {
        /* Show seller-only UI elements */
        document.querySelectorAll('.seller-only').forEach(el => el.style.display = '');

        const shopname = user?.shopname || session.username;
        document.getElementById('ov-shopname').textContent = shopname;

        const products = JSON.parse(
            localStorage.getItem('bakehubSellerProducts') || '[]'
        ).filter(p => p.seller === session.username);
        document.getElementById('ov-listings').textContent = products.length;

        renderListings(products);
    }

    renderOrders(orders);

    /*  Tabs  */
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
    });

    /*  Order History  */
    function renderOrders(orders) {
        const container = document.getElementById('orders-list');
        if (!orders.length) return; // keep empty state

        container.innerHTML = '';
        orders.slice().reverse().forEach(order => {
            const div = document.createElement('div');
            div.className = 'order-item';

            const statusClass = {
                completed: 'status-completed',
                pending:   'status-pending',
                cancelled: 'status-cancelled'
            }[order.status] || 'status-pending';

            div.innerHTML = `
                <div>
                    <div style="font-weight:700;color:#3d2b1f;">${order.items || 'Order'}</div>
                    <div class="order-meta">${order.date || 'N/A'}</div>
                </div>
                <div style="display:flex;align-items:center;gap:14px;">
                    <span class="order-amount">‚Ç±${parseFloat(order.total || 0).toFixed(2)}</span>
                    <span class="order-status ${statusClass}">${order.status || 'Pending'}</span>
                </div>
            `;
            container.appendChild(div);
        });
    }

    /*  Seller Listings  */
    function renderListings(products) {
        const container = document.getElementById('listings-list');
        if (!products.length) return;

        container.innerHTML = '';
        products.forEach(product => {
            const div = document.createElement('div');
            div.className = 'seller-product-item';
            div.innerHTML = `
                <div>
                    <div class="sp-name">${product.name}</div>
                </div>
                <div style="display:flex;align-items:center;gap:16px;">
                    <span class="sp-price">‚Ç±${parseFloat(product.price).toFixed(2)}</span>
                    <button class="sp-remove-btn" data-name="${product.name}">Remove</button>
                </div>
            `;
            div.querySelector('.sp-remove-btn').addEventListener('click', (e) => {
                const name = e.target.dataset.name;
                if (!confirm(`Remove "${name}" from your listings?`)) return;
                let stored = JSON.parse(
                    localStorage.getItem('bakehubSellerProducts') || '[]'
                );
                stored = stored.filter(p => p.name.toLowerCase() !== name.toLowerCase());
                localStorage.setItem('bakehubSellerProducts', JSON.stringify(stored));
                div.remove();

                // Update count
                const remaining = stored.filter(p => p.seller === session.username).length;
                document.getElementById('ov-listings').textContent = remaining;
                if (!remaining) {
                    container.innerHTML = `<div class="empty-state">
                        <div class="empty-icon">üè™</div>
                        <p>You haven't listed any products yet.</p>
                    </div>`;
                }
            });
            container.appendChild(div);
        });
    }

    /*  Change Password  */
    document.getElementById('save-password-btn').addEventListener('click', () => {
        const current = document.getElementById('current-password').value;
        const next    = document.getElementById('new-password').value;
        const confirm = document.getElementById('confirm-password').value;

        if (!current || !next || !confirm) {
            alert('Please fill in all password fields.');
            return;
        }
        if (user.password !== current) {
            alert('Current password is incorrect.');
            return;
        }
        if (next !== confirm) {
            alert('New passwords do not match.');
            return;
        }
        if (next.length < 6) {
            alert('New password must be at least 6 characters.');
            return;
        }

        const users = getUsers();
        users[session.username].password = next;
        saveUsers(users);

        alert('Password updated successfully!');
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value     = '';
        document.getElementById('confirm-password').value = '';
    });

    /*  Profile page logout  */
    document.getElementById('profile-logout-btn').addEventListener('click', () => {
        localStorage.removeItem('bakehubSession');
        window.location.href = 'login.html';
    });

});
</script>
</body>
</html>